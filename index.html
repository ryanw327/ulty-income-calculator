<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ULTY Income Calculator</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React and ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-[#F9FAFB] min-h-screen">
  <div id="root" class="max-w-7xl mx-auto p-6"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef } = React;

    function App() {
      // State variables for main inputs
      const [shares, setShares] = useState(3000);
      const [avgCost, setAvgCost] = useState(5.96);
      const [currentPrice, setCurrentPrice] = useState(5.8);
      const [weeklyDist, setWeeklyDist] = useState(0.10);
      const [rocPercent, setRocPercent] = useState(12.82); // ROC as a percentage

      // Scenario sliders (what-if analysis)
      const [scenarioDist, setScenarioDist] = useState(weeklyDist);
      const [scenarioPrice, setScenarioPrice] = useState(currentPrice);

      // Compute schedule and metrics
      const schedule = useMemo(() => {
        let totalSharesVar = parseFloat(shares);
        const rows = [];
        const labels = [];
        const incomeData = [];
        const sharesData = [];
        const taxableYTDData = [];
        let accTaxable = 0;
        const rocFraction = rocPercent / 100;
        for (let i = 0; i < 52; i++) {
          const distPaid = scenarioDist * totalSharesVar;
          const reinvested = distPaid;
          const newShares = reinvested / scenarioPrice;
          totalSharesVar += newShares;
          const monthlyIncome = distPaid * 4.333;
          const annualIncome = distPaid * 52;
          const taxableWeek = distPaid * (1 - rocFraction);
          accTaxable += taxableWeek;
          rows.push({
            week: i + 1,
            distPerShare: scenarioDist,
            distributionPaid: distPaid,
            reinvested: reinvested,
            newShares: newShares,
            totalShares: totalSharesVar,
            monthlyIncome: monthlyIncome,
            annualIncome: annualIncome,
            taxableWeek: taxableWeek,
            taxableYTD: accTaxable
          });
          labels.push(`W${i + 1}`);
          incomeData.push(annualIncome);
          sharesData.push(totalSharesVar);
          taxableYTDData.push(accTaxable);
        }
        return { rows, labels, incomeData, sharesData, taxableYTDData, finalShares: totalSharesVar };
      }, [shares, scenarioDist, scenarioPrice, rocPercent]);

      // Final metrics
      const finalRow = schedule.rows[schedule.rows.length - 1] || {};
      const avgMonthlyIncome = finalRow.monthlyIncome || 0;
      const annualizedIncome = finalRow.annualIncome || 0;
      const totalValue = finalRow.totalShares * scenarioPrice || 0;
      const initialInvestment = shares * avgCost;
      const totalReturn = totalValue - initialInvestment;
      const ytdTaxable = finalRow.taxableYTD || 0;

      // Chart refs
      const incomeChartRef = useRef(null);
      const breakdownChartRef = useRef(null);

      // Income & Shares chart
      useEffect(() => {
        if (incomeChartRef.current.chartInstance) {
          incomeChartRef.current.chartInstance.destroy();
        }
        const ctxIncome = incomeChartRef.current.getContext('2d');
        incomeChartRef.current.chartInstance = new Chart(ctxIncome, {
          type: 'line',
          data: {
            labels: schedule.labels,
            datasets: [
              {
                label: 'Annualized Income',
                data: schedule.incomeData,
                borderColor: '#065F46',
                backgroundColor: 'rgba(6, 95, 70, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                fill: false
              },
              {
                label: 'Total Shares',
                data: schedule.sharesData,
                borderColor: '#FBBF24',
                backgroundColor: 'rgba(251, 191, 36, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                fill: false,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: 'Annualized Income ($)' },
                grid: { drawOnChartArea: true }
              },
              y1: {
                beginAtZero: true,
                position: 'right',
                title: { display: true, text: 'Total Shares' },
                grid: { drawOnChartArea: false }
              }
            },
            plugins: { legend: { position: 'top' } }
          }
        });
      }, [schedule]);

      // Distribution breakdown chart
      useEffect(() => {
        if (breakdownChartRef.current.chartInstance) {
          breakdownChartRef.current.chartInstance.destroy();
        }
        const ctx = breakdownChartRef.current.getContext('2d');
        const distData = schedule.rows.map((row) => row.distributionPaid);
        const taxableData = schedule.rows.map((row) => row.taxableWeek);
        const nonTaxableData = distData.map((d, i) => d - taxableData[i]);
        breakdownChartRef.current.chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: schedule.labels,
            datasets: [
              {
                label: 'Nonâ€‘Taxable (ROC)',
                data: nonTaxableData,
                backgroundColor: '#A7F3D0'
              },
              {
                label: 'Taxable',
                data: taxableData,
                backgroundColor: '#FBBF24'
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              x: { stacked: true },
              y: {
                stacked: true,
                beginAtZero: true,
                title: { display: true, text: 'Distribution Paid ($)' }
              }
            },
            plugins: { legend: { position: 'top' } }
          }
        });
      }, [schedule]);

      return (
        <div className="space-y-6">
          {/* Navigation / Header */}
          <div className="flex flex-col sm:flex-row items-center justify-between bg-[#065F46] text-white p-4 rounded-md shadow">
            <h1 className="text-3xl font-bold">ULTY Income Calculator</h1>
            <div className="flex space-x-4 mt-2 sm:mt-0">
              <a href="#" className="hover:text-[#FBBF24]">Export CSV</a>
              <a href="#" className="hover:text-[#FBBF24]">Tip Jar</a>
              <a href="#" className="hover:text-[#FBBF24]">Settings</a>
            </div>
          </div>

          {/* Summary Cards */}
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div className="bg-[#A7F3D0] p-4 rounded-md border-l-4 border-[#065F46] shadow">
              <h2 className="text-md font-semibold">Avg Monthly Income</h2>
              <p className="text-3xl font-bold">${avgMonthlyIncome.toFixed(2)}</p>
            </div>
            <div className="bg-[#A7F3D0] p-4 rounded-md border-l-4 border-[#065F46] shadow">
              <h2 className="text-md font-semibold">Annualized Income</h2>
              <p className="text-3xl font-bold">${annualizedIncome.toFixed(2)}</p>
            </div>
            <div className="bg-[#A7F3D0] p-4 rounded-md border-l-4 border-[#065F46] shadow">
              <h2 className="text-md font-semibold">Portfolio Value</h2>
              <p className="text-3xl font-bold">${totalValue.toFixed(2)}</p>
            </div>
            <div className="bg-[#A7F3D0] p-4 rounded-md border-l-4 border-[#065F46] shadow">
              <h2 className="text-md font-semibold">YTD Taxable Income</h2>
              <p className="text-3xl font-bold">${ytdTaxable.toFixed(2)}</p>
            </div>
          </div>

          {/* Charts & Scenario Controls */}
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
            {/* Income & Shares Growth chart */}
            <div className="bg-white p-4 rounded-md shadow flex flex-col">
              <h3 className="text-lg font-semibold mb-2">Weekly Income & Shares Growth</h3>
              <canvas ref={incomeChartRef} height="250"></canvas>
            </div>

            {/* Scenario Planner */}
            <div className="bg-white p-4 rounded-md shadow flex flex-col space-y-4 lg:col-span-1">
              <h3 className="text-lg font-semibold">Scenario Planner</h3>
              <div>
                <label className="block text-sm font-medium">
                  If distribution drops to: <span className="font-bold">{scenarioDist.toFixed(3)}</span> $ per share
                </label>
                <input
                  type="range"
                  min="0"
                  max="0.20"
                  step="0.005"
                  value={scenarioDist}
                  onChange={(e) => setScenarioDist(parseFloat(e.target.value))}
                  className="w-full"
                />
              </div>
              <div>
                <label className="block text-sm font-medium">
                  If price drops to: <span className="font-bold">${scenarioPrice.toFixed(2)}</span>
                </label>
                <input
                  type="range"
                  min="1"
                  max="10"
                  step="0.1"
                  value={scenarioPrice}
                  onChange={(e) => setScenarioPrice(parseFloat(e.target.value))}
                  className="w-full"
                />
              </div>
              <div className="text-xs text-gray-600">
                The charts and metrics update instantly to reflect your whatâ€‘if values above.
              </div>
            </div>
          </div>

          {/* Distribution Breakdown Chart */}
          <div className="bg-white p-4 rounded-md shadow">
            <h3 className="text-lg font-semibold mb-2">Distribution Breakdown</h3>
            <canvas ref={breakdownChartRef} height="250"></canvas>
          </div>

          {/* Weekly Schedule Table */}
          <div className="bg-white p-4 rounded-md shadow overflow-x-auto">
            <h3 className="text-lg font-semibold mb-2">Weekly Schedule (First 12 Weeks)</h3>
            <table className="min-w-full table-auto text-xs">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-2 py-1 border">Week</th>
                  <th className="px-2 py-1 border">Dist / Share ($)</th>
                  <th className="px-2 py-1 border">Reinvested ($)</th>
                  <th className="px-2 py-1 border">Total Shares</th>
                  <th className="px-2 py-1 border">Annualized Income ($)</th>
                </tr>
              </thead>
              <tbody>
                {schedule.rows.slice(0, 12).map((row) => (
                  <tr key={row.week} className={row.week % 2 === 0 ? 'bg-gray-100' : ''}>
                    <td className="px-2 py-1 border text-center">{row.week}</td>
                    <td className="px-2 py-1 border text-right">${row.distPerShare.toFixed(3)}</td>
                    <td className="px-2 py-1 border text-right">${row.distributionPaid.toFixed(2)}</td>
                    <td className="px-2 py-1 border text-right">{row.totalShares.toFixed(4)}</td>
                    <td className="px-2 py-1 border text-right">${row.annualIncome.toFixed(2)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {/* Footer / Tip Message */}
          <footer className="text-center text-sm text-gray-700 mt-6">
            If this helped you forecast your ULTY income, consider leaving a tip ðŸª™
          </footer>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
